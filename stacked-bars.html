<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        .axis .domain {
            display: none;
        }
    </style>
    <script src="https://d3js.org/d3.v4.min.js"></script>
</head>

<body>
    <div class="container">
        <svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 500 500"></svg>
    </div>

    <style>
        .container {
            width: 40%;
        }
    </style>

    <script>
        console.clear()
        

        var svg = d3.select("svg"),
            margin = { top: 60, right: 60, bottom: 60, left: 60 },
            width = +svg.attr("viewBox").split(" ")[2] - margin.left - margin.right,
            height = +svg.attr("viewBox").split(" ")[3] - margin.top - margin.bottom,
            g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");



            console.log(width,height)

        var x0 = d3.scaleBand()
            .rangeRound([0, width])
            .paddingInner(0.1);


        var x1 = d3.scaleBand()
            .padding(0.05);

        var y = d3.scaleLinear()
            .rangeRound([height, 0]);

        var y1 = d3.scaleBand()

        var z = d3.scaleOrdinal()
            .range(["#34D1BF", "#6665DD", "#F17105", "#FAFBFD"]);

        var stack = d3.stack()
            .offset(d3.stackOffsetExpand);

        data = [
                    {
                        "day": "MON",
                        "surgery": "value1",
                        "type": "TIMEOUTS",
                        "value": 2704659
                    },
                    {
                        "day": "MON",
                        "surgery": "value2",
                        "type": "CLOSING TIMEOUTS",
                        "value": 0
                    },
                    {
                        "day": "MON",
                        "surgery": "value3",
                        "type": "SURGICAL PREP",
                        "value": 0
                    },
                    {
                        "day": "MON",
                        "surgery": "fade",
                        "type": "TIMEOUTS",
                        "value": 999999
                    },
                    {
                        "day": "MON",
                        "surgery": "fade",
                        "type": "CLOSING TIMEOUTS",
                        "value": 999999
                    },
                    {
                        "day": "MON",
                        "surgery": "fade",
                        "type": "SURGICAL PREP",
                        "value": 999999
                    },
                    {
                        "day": "TUE",
                        "surgery": "value1",
                        "type": "TIMEOUTS",
                        "value": 2027307
                    },
                    {
                        "day": "TUE",
                        "surgery": "value2",
                        "type": "CLOSING TIMEOUTS",
                        "value": 2290857
                    },
                    {
                        "day": "TUE",
                        "surgery": "value3",
                        "type": "SURGICAL PREP",
                        "value": 2817957
                    },
                    {
                        "day": "TUE",
                        "surgery": "fade",
                        "type": "TIMEOUTS",
                        "value": 999999
                    },
                    {
                        "day": "TUE",
                        "surgery": "fade",
                        "type": "CLOSING TIMEOUTS",
                        "value": 999999
                    },
                    {
                        "day": "TUE",
                        "surgery": "fade",
                        "type": "SURGICAL PREP",
                        "value": 999999
                    },
                    {
                        "day": "WED",
                        "surgery": "value1",
                        "type": "TIMEOUTS",
                        "value": 1208495
                    },
                    {
                        "day": "WED",
                        "surgery": "value2",
                        "type": "CLOSING TIMEOUTS",
                        "value": 1087646
                    },
                    {
                        "day": "WED",
                        "surgery": "value3",
                        "type": "SURGICAL PREP",
                        "value": 845947
                    },
                    {
                        "day": "WED",
                        "surgery": "fade",
                        "type": "TIMEOUTS",
                        "value": 999999
                    },
                    {
                        "day": "WED",
                        "surgery": "fade",
                        "type": "CLOSING TIMEOUTS",
                        "value": 999999
                    },
                    {
                        "day": "WED",
                        "surgery": "fade",
                        "type": "SURGICAL PREP",
                        "value": 999999
                    },
                    {
                        "day": "THU",
                        "surgery": "value1",
                        "type": "TIMEOUTS",
                        "value": 1140516
                    },
                    {
                        "day": "THU",
                        "surgery": "value2",
                        "type": "CLOSING TIMEOUTS",
                        "value": 1231757
                    },
                    {
                        "day": "THU",
                        "surgery": "value3",
                        "type": "SURGICAL PREP",
                        "value": 1414240
                    },
                    {
                        "day": "THU",
                        "surgery": "fade",
                        "type": "TIMEOUTS",
                        "value": 999999
                    },
                    {
                        "day": "THU",
                        "surgery": "fade",
                        "type": "CLOSING TIMEOUTS",
                        "value": 999999
                    },
                    {
                        "day": "THU",
                        "surgery": "fade",
                        "type": "SURGICAL PREP",
                        "value": 999999
                    },
                    {
                        "day": "FRI",
                        "surgery": "value1",
                        "type": "TIMEOUTS",
                        "value": 894368
                    },
                    {
                        "day": "FRI",
                        "surgery": "value2",
                        "type": "CLOSING TIMEOUTS",
                        "value": 912255
                    },
                    {
                        "day": "FRI",
                        "surgery": "value3",
                        "type": "SURGICAL PREP",
                        "value": 948030
                    },
                    {
                        "day": "FRI",
                        "surgery": "fade",
                        "type": "TIMEOUTS",
                        "value": 999999
                    },
                    {
                        "day": "FRI",
                        "surgery": "fade",
                        "type": "CLOSING TIMEOUTS",
                        "value": 999999
                    },
                    {
                        "day": "FRI",
                        "surgery": "fade",
                        "type": "SURGICAL PREP",
                        "value": 999999
                    },
                    {
                        "day": "SAT",
                        "surgery": "value1",
                        "type": "TIMEOUTS",
                        "value": 737462
                    },
                    {
                        "day": "SAT",
                        "surgery": "value2",
                        "type": "CLOSING TIMEOUTS",
                        "value": 781710
                    },
                    {
                        "day": "SAT",
                        "surgery": "value3",
                        "type": "SURGICAL PREP",
                        "value": 870205
                    },
                    {
                        "day": "SAT",
                        "surgery": "fade",
                        "type": "TIMEOUTS",
                        "value": 999999
                    },
                    {
                        "day": "SAT",
                        "surgery": "fade",
                        "type": "CLOSING TIMEOUTS",
                        "value": 999999
                    },
                    {
                        "day": "SAT",
                        "surgery": "fade",
                        "type": "SURGICAL PREP",
                        "value": 999999
                    },
                    {
                        "day": "SUN",
                        "surgery": "value1",
                        "type": "TIMEOUTS",
                        "value": 737462
                    },
                    {
                        "day": "SUN",
                        "surgery": "value2",
                        "type": "CLOSING TIMEOUTS",
                        "value": 781710
                    },
                    {
                        "day": "SUN",
                        "surgery": "value3",
                        "type": "SURGICAL PREP",
                        "value": 870205
                    },
                    {
                        "day": "SUN",
                        "surgery": "fade",
                        "type": "TIMEOUTS",
                        "value": 999999
                    },
                    {
                        "day": "SUN",
                        "surgery": "fade",
                        "type": "CLOSING TIMEOUTS",
                        "value": 999999
                    },
                    {
                        "day": "SUN",
                        "surgery": "fade",
                        "type": "SURGICAL PREP",
                        "value": 999999
                    }
                ]

        x0.domain(data.map(function (d) { return d.day; }));
        x1.domain(data.map(function (d) { return d.type; }))
            .rangeRound([0, x0.bandwidth()])
            .padding(0.2);

        z.domain(data.map(function (d) { return d.surgery; }))
        var keys = z.domain()

        var groupData = d3.nest()
            .key(function (d) { return d.type + d.day; })
            .rollup(function (d, i) {

                var d2 = { type: d[0].type, day: d[0].day }
                d.forEach(function (d) {
                    d2[d.surgery] = d.value
                })
                console.log("rollup d", d, d2);
                return d2;
            })
            .entries(data)
            .map(function (d) { return d.value; });

        console.log("groupData", groupData)

        var stackData = stack
            .keys(keys)(groupData)

        console.log("stackData", stackData)

        //y.domain([0, d3.max(data, function(d) { return d.value; })]).nice();

        console.log("keys", keys)

        var serie = g.selectAll(".serie")
            .data(stackData)
            .enter().append("g")
            .attr("class", "serie")
            .attr("fill", function (d) { return z(d.key); });

        serie.selectAll("rect")
            .data(function (d) { return d; })
            .enter().append("rect")
            .attr("class", "serie-rect")
            .attr("transform", function (d) { return "translate(" + x0(d.data.day) + ",0)"; })
            .attr("x", function (d) { return x1(d.data.type); })
            .attr("y", function (d) { return y(d[1]); })
            .attr("height", function (d) { return y(d[0]) - y(d[1]); })
            .attr("width", "12")
            .on("click", function (d, i) { console.log("serie-rect click d", i, d); });

        g.append("g")
            .attr("class", "axis")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x0));

        g.append("g")
            .attr("class", "axis")
            .call(d3.axisLeft(y).ticks(null, "s"))
            .append("text")
            .attr("x", 2)
            .attr("y", y(y.ticks().pop()) + 0.5)
            .attr("dy", "0.32em")
            .attr("fill", "#000")
            .attr("font-weight", "bold")
            .attr("text-anchor", "start")
            // .text("Population");

        var legend = serie.append("g")
            .attr("class", "legend")
            .attr("transform", function (d) { var d = d[d.length - 1]; return "translate(" + (x0(d.data.day) + x1(d.data.type) + x1.bandwidth()) + "," + ((y(d[0]) + y(d[1])) / 2) + ")"; });

        // legend.append("line")
        //     .attr("x1", -6)
        //     .attr("x2", 6)
        //     .attr("stroke", "#000");

        // legend.append("text")
        //     .attr("x", 9)
        //     .attr("dy", "0.35em")
        //     .attr("fill", "#000")
        //     .style("font", "10px sans-serif")
        //     .text(function (d) { return d.key; });

        
        document.querySelectorAll('body svg > g > g > rect').forEach( e => {  e.setAttribute('rx',8) })
        document.querySelectorAll('body svg > g > g:nth-child(5) > g > line').forEach( e => {  e.remove() })

    </script>
</body>

</html>